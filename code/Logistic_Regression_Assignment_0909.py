# μΆ…μ†λ³€μ: λ°±νλ³‘ μ„Έν¬ κ΄€μΈ΅ λ¶κ°€ μ—¬λ¶€ (REMISS), 1μ΄λ©΄ κ΄€μΈ΅ μ•λ¨μ„ μλ―Έ

# λ…λ¦½λ³€μ:
# κ³¨μμ μ„Έν¬μ„± (CELL)
# κ³¨μνΈμ λ°±νκµ¬ λΉ„μ¨ (SMEAR)
# κ³¨μμ λ°±νλ³‘ μ„Έν¬ μΉ¨ν¬ λΉ„μ¨ (INFIL)
# κ³¨μ λ°±νλ³‘ μ„Έν¬μ λΌλ²¨λ§ μΈλ±μ¤ (LI)
# λ§μ΄νμ•΅μ λ°±νλ³‘ μ„Έν¬ μ (BLAST)
# μΉλ£ μ‹μ‘ μ „ μµκ³  μ²΄μ¨ (TEMP)


## λ¬Έμ  1.
## λ°μ΄ν„°λ¥Ό λ΅λ“ν•κ³ , λ΅μ§€μ¤ν‹± νκ·€λ¨λΈμ„ μ ν•©ν•κ³ , νκ·€ ν‘λ¥Ό μ‘μ„±ν•μ„Έμ”.

# λ°μ΄ν„° λ΅λ“
import pandas as pd

df = pd.read_csv('../data/leukemia_remission.txt', delim_whitespace= True) # delim_whitespace : κ³µλ°± μ§€μ°κΈ°
df.head()

train = df.drop(columns=('REMISS')) # λ…λ¦½λ³€μλ§

# λ΅μ§€μ¤ν‹± νκ·€λ¨λΈ μ ν•©, νκ·€ ν‘ μ‘μ„±
import statsmodels.api as sm
model = sm.formula.logit("REMISS ~ CELL + SMEAR + INFIL + LI + BLAST + TEMP", data=df).fit()
print(model.summary())


## λ¬Έμ  2.
## ν•΄λ‹Ή λ¨λΈμ€ ν†µκ³„μ μΌλ΅ μ μν•κ°€μ”? κ·Έ μ΄μ λ¥Ό κ²€μ •ν†µκ³„λ‰λ¥Ό μ‚¬μ©ν•΄μ„ μ„¤λ…ν•μ‹μ¤.
# β’2(β„“(π›½)Μ‚ (0) β’ β„“(π›½)Μ‚ )  =  -2*(-17.186+10.797)  = 12.779
from scipy.stats import chi2
1 - chi2.cdf(12.779, df=6)  # 0.0466828104726148

# LLR p-value: 0.0467 < μ μμμ¤€ 0.05λ³΄λ‹¤ μ‘μΌλ‹κΉ ν†µκ³„μ μΌλ΅ μ μν•λ‹¤κ³  ν•  μ μλ‹¤.


# λ¬Έμ  3.
# μ μμμ¤€μ΄ 0.2λ¥Ό κΈ°μ¤€μΌλ΅ ν†µκ³„μ μΌλ΅ μ μν• λ³€μλ” λ‡κ°μ΄λ©°, μ–΄λ λ³€μ μΈκ°€μ”?
# P>|z|κ°€ 0.2λ³΄λ‹¤ μ‘μ€ LI, TEMPκ°€ μ μν•λ‹¤


# λ¬Έμ  4. λ‹¤μ ν™μμ— λ€ν• μ¤μ¦λ” μ–Όλ§μΈκ°€μ”?
# CELL (κ³¨μμ μ„Έν¬μ„±): 65%
# SMEAR (κ³¨μνΈμ λ°±νκµ¬ λΉ„μ¨): 45%
# INFIL (κ³¨μμ λ°±νλ³‘ μ„Έν¬ μΉ¨ν¬ λΉ„μ¨): 55%
# LI (κ³¨μ λ°±νλ³‘ μ„Έν¬μ λΌλ²¨λ§ μΈλ±μ¤): 1.2
# BLAST (λ§μ΄νμ•΅μ λ°±νλ³‘ μ„Έν¬ μ): 1.1μ„Έν¬/ΞΌL
# TEMP (μΉλ£ μ‹μ‘ μ „ μµκ³  μ²΄μ¨): 0.9

import numpy as np
log_odds=64.2581 + 30.8301*0.65 + 24.6863*0.45 + -24.9745*0.55 + 4.3605*1.2 + -0.0115*1.1 + -100.1734*0.9
odds = np.exp(log_odds) # 0.03817459641135519


## λ¬Έμ  5. μ„ ν™μμ νμ•΅μ—μ„ λ°±νλ³‘ μ„Έν¬κ°€ κ΄€μΈ΅λμ§€ μ•μ€ ν™•λ¥ μ€ μ–Όλ§μΈκ°€μ”?
p_hat = odds / (odds + 1) # 0.03677088280074742


## λ¬Έμ  6. TEMP λ³€μμ κ³„μλ” μ–Όλ§μ΄λ©°, ν•΄λ‹Ή κ³„μλ¥Ό μ‚¬μ©ν•΄μ„ TEMP λ³€μκ°€ λ°±νλ³‘ μΉλ£μ— λ€ν• μν–¥μ„ μ„¤λ…ν•μ‹μ¤.
np.exp(-100.1734)
# 3.13e-44 - > 0μ— κ°€κΉμ΄ κ°’μ…λ‹λ‹¤.
# μ²΄μ¨μ΄ 1λ‹¨μ„ μƒμΉν•  λ• λ°±νλ³‘ μ„Έν¬κ°€ κ΄€μΈ΅λμ§€ μ•μ„ ν™•λ¥ μ΄ (μ¤μ¦λΉ„λ§νΌ λ³€λ™)κ±°μ μ—†μ–΄μ§€λ” κ²ƒμ„ μλ―Έ
# -> TEMP λ†’μ„μλ΅ λ°±νλ³‘ μ„Έν¬κ°€ κ΄€μΈ΅λμ§€ μ•μ„ ν™•λ¥ μ΄ λ§¤μ° λ‚®μ•„μ§

## λ¬Έμ  7. CELL λ³€μμ 99% μ¤μ¦λΉ„μ— λ€ν• μ‹ λΆ°κµ¬κ°„μ„ κµ¬ν•μ‹μ¤.

# CELL λ³€μμ λ² νƒ€μ— λ€ν• 99 : (λ² νƒ€_hat - z(0.005)*SE(std_err) , λ² νƒ€_hat + z(0.005)*SE)
from scipy.stats import norm
z0005 = norm.ppf(0.995, loc=0, scale=1)
30.8301 - 52.135*z0005 , 30.8301 + 52.135*z0005
np.exp(30.8301 - 52.135*z0005) , np.exp(30.8301 + 52.135*z0005)  # (1.1683218982002717e-45, 5.141881884993857e+71)


## λ¬Έμ  8. μ£Όμ–΄μ§„ λ°μ΄ν„°μ— λ€ν•μ—¬ λ΅μ§€μ¤ν‹± νκ·€ λ¨λΈμ μμΈ΅ ν™•λ¥ μ„ κµ¬ν• ν›„
# 50% μ΄μƒμΈ κ²½μ° 1λ΅ μ²λ¦¬ν•μ—¬, νΌλ™ ν–‰λ ¬λ¥Ό κµ¬ν•μ‹μ¤.

from sklearn.metrics import confusion_matrix, ConfusionMatrixDisplay
import matplotlib.pyplot as plt

y_pred = model.predict(train)
result = pd.DataFrame({'y_pred' : y_pred})
result['result'] = np.where(result['y_pred']>=0.5, 1,0)

conf_mat = confusion_matrix(y_true = df['REMISS'], y_pred = result['result'], labels=[1,0])
p = ConfusionMatrixDisplay(confusion_matrix = conf_mat, display_labels = ('κ΄€μΈ΅λ¶κ°€_1', 'κ΄€μΈ΅κ°€λ¥_0'))
plt.rcParams['font.family'] = 'Malgun Gothic'
p.plot(cmap="Blues")


## λ¬Έμ  9. ν•΄λ‹Ή λ¨λΈμ Accuracyλ” μ–Όλ§μΈκ°€μ”?

(5+15)/(5+3+4+15)  # 0.7407407407407407

from sklearn.metrics import accuracy_score, f1_score
accuracy_score(df['REMISS'], result['result'])  # 0.7407407407407407


## λ¬Έμ  10. ν•΄λ‹Ή λ¨λΈμ F1 Scoreλ¥Ό κµ¬ν•μ„Έμ”.

precision = 5/(5+3)
recall = 5/(5+4)

2 / (1/precision + 1/recall)   # 0.5882352941176471

f1_score(df['REMISS'], result['result'])  # 0.5882352941176471